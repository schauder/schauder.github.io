---
layout: default
status: publish
published: true
title: 'New Feature of JUnit: Rules '
author:
  display_name: Jens Schauder
  login: admin
  email: jens@schauderhaft.de
  url: http://blog.schauderhaft.de
author_login: admin
author_email: jens@schauderhaft.de
author_url: http://blog.schauderhaft.de
wordpress_id: 252
wordpress_url: http://blog.schauderhaft.de/?p=252
date: '2009-10-04 12:12:20 +0200'
date_gmt: '2009-10-04 10:12:20 +0200'
categories:
- article
- Softwaredevelopment
tags:
- testing
- Java
- junit
- Rule
comments:
- id: 273
  author: 'Tweets die Schauderhaft &Acirc;&raquo; New Feature of JUnit: Rules erw&Atilde;&curren;hnt
    -- Topsy.com'
  author_email: ''
  author_url: http://topsy.com/tb/bit.ly/jYlaC
  date: '2009-10-05 00:17:09 +0200'
  date_gmt: '2009-10-04 22:17:09 +0200'
  content: "[...] Dieser Eintrag wurde auf Twitter von A. Ebbert-Karroum erw&Atilde;&curren;hnt.
    A. Ebbert-Karroum sagte: Andreas empfiehlt: New Feature of JUnit: Rules http://bit.ly/3igO6
    [...]"
- id: 274
  author: DingensBummens | Das Ding was Bummst &raquo; My Google Reader Shared Items
    &#8211; Monday, October 5, 2009
  author_email: ''
  author_url: http://www.dingensbummens.de/2009/10/05/my-google-reader-shared-items-monday-october-5-2009/
  date: '2009-10-05 18:03:16 +0200'
  date_gmt: '2009-10-05 16:03:16 +0200'
  content: "[...] New Feature of JUnit: Rules [...]"
- id: 275
  author: Brian Gilstrap
  author_email: brian@ociweb.com
  author_url: http://viewfromthefringe.blogspot.com/
  date: '2009-10-06 19:30:17 +0200'
  date_gmt: '2009-10-06 17:30:17 +0200'
  content: "I think this is a great power feature to have for those situations where
    it is needed. I find AOP to be problematic when it comes to diagnosing what is
    going wrong with a system that isn't doing what is expected, so I would rather
    not use AOP.\r\n\r\n I have to wonder if there might not be a way to add a few
    more annotations to facilitate trying to execute a test method and then doing
    some sort of recovery work if it fails that would be easier to understand. That
    said, this is certainly a more general API and can be used for many things.\r\n\r\nThanks
    for taking the time to describe it."
- id: 611
  author: "&Icirc;\x9D&Icirc;&shy;&Icirc;&plusmn; &Iuml;&Dagger;&Icirc;&plusmn;&Iuml;\x81&Icirc;&plusmn;&Icirc;&ordm;&Iuml;&bdquo;&Icirc;&middot;&Iuml;\x81&Icirc;&sup1;&Iuml;&fnof;&Iuml;&bdquo;&Icirc;&sup1;&Icirc;&ordm;&Icirc;&not;
    &Iuml;&fnof;&Iuml;&bdquo;&Icirc;&iquest; JUnit 4 &laquo; Java Hellenic User Group"
  author_email: ''
  author_url: http://www.jhug.gr/?p=1027
  date: '2010-07-13 16:14:36 +0200'
  date_gmt: '2010-07-13 14:14:36 +0200'
  content: "[...] JUnit Rules [...]"
- id: 680
  author: 'A Smattering of Selenium #23 &laquo; Official Selenium Blog'
  author_email: ''
  author_url: http://seleniumhq.wordpress.com/2010/08/16/a-smattering-of-selenium-23/
  date: '2010-08-16 13:27:37 +0200'
  date_gmt: '2010-08-16 11:27:37 +0200'
  content: "[...] amounts of power hiding in that there JUnit 4 library &#8211; such
    as @Rule. One usage of them is described here. A useful pattern indeed when doing
    something like BDD or [...]"
- id: 907
  author: Experimentelle Features von JUnit
  author_email: ''
  author_url: http://www.jug-ostfalen.de/?p=343
  date: '2010-09-27 00:11:56 +0200'
  date_gmt: '2010-09-26 22:11:56 +0200'
  content: "[...] Etwas komplexer sind Rules.&Acirc;&nbsp; Dazu gibt es auch einen
    ausf&Atilde;&frac14;hrlichen und sehr anschaulichen Blogbeitrag von Jens, auf
    den ich hier verweisen m&Atilde;&para;chte. Blick &Atilde;&frac14;ber [...]"
- id: 3400
  author: Vortrag &#8216;Testen mit Scala&#8217;
  author_email: ''
  author_url: http://www.jug-ostfalen.de/?p=520
  date: '2011-04-17 23:36:42 +0200'
  date_gmt: '2011-04-17 21:36:42 +0200'
  content: "[...] JUnit Rules: http://blog.schauderhaft.de/2009/10/04/junit-rules/
    [...]"
- id: 4103
  author: Philip May
  author_email: eniak.info@googlemail.com
  author_url: http://eniak.info/
  date: '2011-08-21 11:32:45 +0200'
  date_gmt: '2011-08-21 09:32:45 +0200'
  content: "<cite>So, what do you think of this feature? Any ideas for features that
    could be implemented using rules?</cite>\r\n\r\nYou could for example get
    the execution time of each test method and log the 10 most slowest into a file."
- id: 4191
  author: 'DRY: Use JUnit @Rule Instead of Repeating Setup/@Before in Each Test
    &laquo; The Holy Java'
  author_email: ''
  author_url: http://theholyjava.wordpress.com/2011/09/04/dry-use-junit-rule-instead-of-repeating-setupbefore-in-each-test/
  date: '2011-09-04 19:12:39 +0200'
  date_gmt: '2011-09-04 17:12:39 +0200'
  content: "[...] I was for a long time unhappy that&Acirc;&nbsp;DbUnit Express&Acirc;&nbsp;users
    have to create a @Before method in each test just to get the test database initialized.
    Fortunately since version 1.3.0 they don&#8217;t need to do it anymore thanks
    to JUnit Rules&Acirc;&nbsp;(if you are not familiar with them, they are an alternative
    to @Before/@After and @BeforeClass/@AfterClass, read this rules introduction).
    [...]"
- id: 4764
  author: JUnit Rules &laquo; Java Mania
  author_email: ''
  author_url: http://unpocodejava.wordpress.com/2012/01/12/junit-rules/
  date: '2012-01-12 11:02:39 +0100'
  date_gmt: '2012-01-12 09:02:39 +0100'
  content: "[...] http://blog.schauderhaft.de/2009/10/04/junit-rules/
    [...]"
- id: 5924
  author: Dhiraj
  author_email: dhiraj@gmail.com
  author_url: http://dhiraj.blogspot.com
  date: '2012-04-18 22:36:19 +0200'
  date_gmt: '2012-04-18 20:36:19 +0200'
  content: Thanks for the good,brief explanation of this feature. My first read about
    @Rule and it gives me the whole picture.
---
<p>[caption id="attachment_258" align="alignleft" width="300" caption="card board box"]<img class="size-medium wp-image-258" title="1117482_76414816" src="http://blog.schauderhaft.de/wp-content/uploads/2009/10/1117482_76414816-300x200.jpg" alt="card board box" width="300" height="200" />[/caption]</p>
<p>I am always surprised how many unknown feature hide in a supposedly simple library. Todays example is <a href="http://junit.org/">JUnit</a>. When inspecting the newest version (4.7) I noted an annotation I hadn't noticed before: <tt>@Rule</tt>. WTF? I am looking at a testing framework and not at a rules engine, am I? So naturally I tried to find out what it is good for, and since not to much documentation is available my little research resulted in this blog post. Enjoy.</p>
<p>The purpose of the <tt>@Rule</tt> annotation is to mark public fields of a test class. These fields&Acirc;&nbsp; must be of type <tt>MethodRule</tt>, or an implementing class. Such <tt>MethodRule</tt>s behave similar to a AOP aspects, of course without use of any AOP library and specialized for Tests. They can execute code before, after or instead of a test method.&Acirc;&nbsp; Example use cases listed in the <a href="http://github.com/KentBeck/junit/raw/23ffc6baf5768057e366e183e53f4dfa86fbb005/doc/ReleaseNotes4.7.txt">release notes</a> include:</p>
<ul>
<li>Notification on tests</li>
<li>Setting up or tearing down resources, especially when they are used in multiple test classes</li>
<li>Special checks performed after every test, possibly causing a test to fail.</li>
<li>Making information about the test available inside the test</li><br />
</ul><br />
But ready made examples are boring, so I decided to try to implement something I was looking for all the time.</p>
<p>When writing acceptance tests with <a href="http://fit.c2.com/">Fit</a> or a similiar framework, you might end up with tons of failing tests, simply because the features aren't implemented yet. But I don't want this red lights hide a real red light, i.e. a test that worked before, but fails now. Therefore I'd like tests to get ignored just as if they where accordingly annotated, until they succeed for the first time. After that they should run (and possibly fail) just as a normal.</p>
<p>Let's get started. First we need a little test case that can fail or succeed as we want. And this test case of course needs our annotated field:</p>
<pre lang="java">public class DummyTest {</p>
<p>    @Rule<br />
    public IgnoreLeadingFailure ilf = new IgnoreLeadingFailure();</p>
<p>    @Test<br />
    public void testTest() {<br />
        assertTrue(false);<br />
    }<br />
}</pre><br />
Please note that I stripped all package and import statements for brevity. As you can see I already named my <tt>MethodRule</tt> implementation <tt>IgnoreLeadingFailure</tt>. It needs some way to track which tests ran successfully at least once. Since I am lazy, I stored this information in a property file.</p>
<pre lang="java">public class IgnoreLeadingFailure implements MethodRule {</p>
<p>    private final static String PROPERTY_FILE_NAME = "activatedTests.properties";</p>
<p>    private final static Properties activatedTests = new Properties();</p>
<p>    static {<br />
        try {<br />
            activatedTests.load(new FileInputStream(PROPERTY_FILE_NAME));<br />
        } catch (IOException e) {<br />
            // actually this is to be expected on the first run<br />
            System.out.println("Couldn't load Properties from file" + e);<br />
        }<br />
    }</p>
<p>    public Statement apply(final Statement base, final FrameworkMethod method,<br />
            final Object target) {</p>
<p>        if (activatedTests.containsKey(getFullTestMethodName(method, target))) {<br />
            return base;<br />
        } else {</p>
<p>            return new Statement() {</p>
<p>                @Override<br />
                public void evaluate() throws Throwable {<br />
                    try {<br />
                        base.evaluate();<br />
                        activateTest(getFullTestMethodName(method, target));<br />
                    } catch (Throwable t) {<br />
                        throw new AssumptionViolatedException(<br />
                                "This test never succeeded before, and failed again with: "<br />
                                        + t.toString());<br />
                    }<br />
                }</p>
<p>                private void activateTest(String fullTestMethodName) {<br />
                    activatedTests.put(fullTestMethodName,<br />
                            new SimpleDateFormat().format(new Date()));<br />
                    try {<br />
                        activatedTests.store(new FileOutputStream(<br />
                                PROPERTY_FILE_NAME),<br />
                                "tests that ran successfully at least once");<br />
                    } catch (IOException io) {<br />
                        System.out.println("failed to store properties" + io);<br />
                    }</p>
<p>                }<br />
            };<br />
        }<br />
    }</p>
<p>    private String getFullTestMethodName(final FrameworkMethod method,<br />
            Object target) {<br />
        return target.getClass().getName() + " " + method.getName();<br />
    }<br />
}</pre><br />
The interesting part is the single method contained in the <tt>MethodRule</tt> interface:</p>
<pre lang="java">public Statement apply(final Statement base, final FrameworkMethod method, final Object target)</pre><br />
<strong>base</strong> is the object that encapsulates the execution of the test method. The purpose of <tt>apply(..)</tt> is to provide a Statement. This Statement will get executed (or in the lingo of the interface 'evaluated'). Typically you'll return a <tt>Statement</tt> implementation, that wraps the <tt>Statement</tt> instance passed as a parameter.</tt></p>
<p><strong>method</strong> is the test method that will eventually get called and</p>
<p><strong>target</strong> is the object containing that method. Note that you normally do not execute the method, but use it mainly to get more information about the test case the <tt>MethodRule</tt> is applied to.</p>
<p>With this information it should be easy to understand what my little class does: It checks if the test at hand was already executed successfully before. If this is the case, the same <tt>Statement</tt> is returned, that was passed as a parameter. Otherwise an anonymous implementation is returned which replaces any failure by a <tt>AssumptionViolatedException</tt>, and saves a successful test run in the property file. Note that the <tt>AssumptionViolatedException</tt> actually does not result in a ignored test, but gets displayed as a successful test, at least with the default runner, which doesn't really fit my needs, but one could easily fix that by a minor change in the runner but not without that change.</p>
<p>So here is my opinion about this new JUnit feature: It certainly can come in handy for (integration) tests, where one tends to need a lot of resources that need quite some setup and/or tear down. Implementation of a <tt>MethodRule</tt> is fairly easy, although not exactly straight forward. The biggest problem is that it is next to impossible for an average java developer who doesn't know this feature to understand what is going on. The annotated field is easily missed, since in many cases it isn't used at all in the test class. Once more all this could be straight forward when java would support natively things like aspect oriented programming or open classes.</p>
<p>If you want more information I suggest you drop by <a href="http://www.threeriversinstitute.org/blog/?p=155">this blog post about 'Interceptors' which was the name for rules</a> at the time of writing of that post.</p>
<p>So, what do you think of this feature? Any ideas for features that could be implemented using rules?</p>
